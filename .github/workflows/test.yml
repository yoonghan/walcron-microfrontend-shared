name: Validate project

on:
  workflow_call:
    inputs:
      upload_codecov:
        description: Upload into code coverage
        default: false
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: üõë Cancel previous runs
        uses: styfle/cancel-workflow-action@0.12.1

      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v5
        with:
          fetch-depth: ${{ github.ref == 'refs/heads/main' && '0' || '1' }} # Fetch all history for all branches for sonarqube analysis


      - name: ‚éî Setup node
        uses: actions/setup-node@v5
        with:
          node-version: ${{ matrix.node }}
          cache: "npm"

      - name: Cache dependencies
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ./node_modules
            ~/.cache/ms-playwright
          key: modules-test-${{ hashFiles('package-lock.json') }}

      - name: üì• Download deps
        uses: bahmutov/npm-install@v1

      - name: Install Playwright Browsers
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          npx playwright install chromium

      - name: ‚úÖ Validate lint, prettier and build
        run: npm run build

      - name: ‚úÖ Validate test script
        run: npm run test:ci

      # - name: SonarQube Scan ## use auto check from sonarqube via Project -> Administration -> Analysis Method -> Check Automatic Analysis
      #   uses: SonarSource/sonarqube-scan-action@v5
      #   if: github.ref == 'refs/heads/main'
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: ‚úÖ Validate e2e test
        run: export IGNORE_SKIPPABLE_TEST=true && npm run e2e

      - name: üìÅ Code coverage report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage/**/cobertura-coverage.xml
          badge: true
          format: "markdown"
          output: "both"

      - name: + Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: startsWith(github.head_ref, 'dependabot/') != true
        with:
          recreate: true
          path: code-coverage-results.md

      - name: Upload coverage reports to Codecov
        if: ${{ inputs.upload_codecov }} == true
        uses: codecov/codecov-action@v5.5.1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
